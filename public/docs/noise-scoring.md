# 🎙️ 噪音评分系统详解

Immersive Clock 的噪音监测系统不仅仅是一个简单的分贝计，它内置了一个基于心理声学与专注力理论的评分引擎。该引擎旨在客观、多维度地量化环境噪音对学习心流的干扰程度。

本文档详细解析了该系统的计算原理、核心指标定义及评分算法。

## 1. 核心理念

系统认为，并非所有“响声”都是一样的。对于专注力而言：
*   **持续的嗡嗡声**（如嘈杂的人群）比**偶尔的掉笔声**更具破坏性。
*   **频繁的打断**（如每分钟都有人说话）比**单次的大声喧哗**更让人烦躁。

因此，评分系统采用了 **多维度加权扣分制**，满分 100 分，根据环境表现进行扣分。

## 2. 数据采集与预处理

系统通过 Web Audio API 实时采集音频流：
1.  **采样率**：每秒采集约 20-50 帧音频样本（取决于设备性能）。
2.  **原始特征**：计算每一帧的 `DBFS` (Decibels relative to Full Scale)。
    > **注意**：评分系统始终使用**原始 DBFS** 进行计算，而不使用用户校准后的显示分贝 (Display dB)。这保证了评分的客观性，不受用户随意调整校准值的影响。

## 3. 三大核心指标

评分引擎从以下三个维度对噪音数据进行分析：

### A. 持续噪音水平 (Sustained Level)
*   **定义**：剔除突发噪音后的环境“底噪”水平。
*   **算法**：使用时段内所有帧的中位数电平 (`p50Dbfs`)。
*   **意义**：反映环境本身是否安静。如果环境中有持续的风扇声或交谈声，该指标会升高。

### B. 超阈值时长占比 (Over Threshold Ratio)
*   **定义**：音量超过设定报警阈值的时间比例。
*   **算法**：`超标帧数 / 总帧数`。
*   **意义**：反映环境的“纯净度”。即使是 0.1 秒的尖叫也会被精确计入，无法被平均值掩盖。

### C. 打断次数密度 (Interruption Density)
*   **定义**：单位时间内（每分钟）发生的独立噪音事件次数。
*   **智能合并算法**：
    *   系统设有 **300ms** (默认) 的合并窗口。
    *   如果两次响声间隔小于该窗口（如拉椅子的一连串声音），会被合并为 **1 次打断**。
    *   只有间隔较长的响声才会被计为新的打断。
*   **意义**：反映环境的干扰频率。频繁的打断（如断断续续的说话声）比连续的噪音更易打断心流。

## 4. 评分计算公式

最终得分 (`Score`) 计算公式如下：

$$ \text{Score} = 100 \times (1 - \text{TotalPenalty}) $$

其中 **总惩罚系数 (`TotalPenalty`)** 由三个加权项组成：

$$ \text{TotalPenalty} = 0.55 \times P_{\text{sustained}} + 0.30 \times P_{\text{time}} + 0.15 \times P_{\text{segment}} $$

| 维度 | 权重 | 扣分逻辑 (达到满扣分的条件) |
| :--- | :--- | :--- |
| **持续噪音** ($P_{\text{sustained}}$) | **55%** | 中位数电平超过阈值 **6dB** 以上 |
| **超阈时长** ($P_{\text{time}}$) | **30%** | 超阈时间占比达到 **30%** |
| **打断频次** ($P_{\text{segment}}$) | **15%** | 打断次数达到 **6 次/分钟** |

### 权重解读
*   **持续噪音 (55%)** 是最大的扣分项。这意味着如果环境一直很吵，分数绝对不会高。
*   **超阈时长 (30%)** 其次。只要大部分时间是安静的，偶尔的噪音是可以被容忍的。
*   **打断频次 (15%)** 权重最低，主要用于惩罚那些“虽然声音不大，但很细碎烦人”的场景。

## 5. 报告中的图表

在噪音统计报告中，您可以直观地看到这些数据：

*   **评分走势图**：展示了 `Score` 随时间的变化，帮助您回顾专注状态。
*   **噪音等级分布**：将每一帧归类为安静/正常/吵闹/极吵，直观展示时间占比。
*   **扣分归因**：直接显示上述三个维度的扣分比例，告诉您为什么分低（是因为一直吵，还是因为总被打断）。
*   **打断次数密度**：展示每分钟被干扰的次数。

---
*本文档对应代码实现位于 `src/utils/noiseScoreEngine.ts` 与 `src/services/noise/noiseSliceAggregator.ts`。*
